/**
 * PDB Sequence Viewer
 * @version v1.0.0
 * @link https://github.com/mandarsd/pdb-sequence-viewer
 * @license Apache 2.0
 */
/**
 * Copyright 2015-2016 Mandar Deshpande <mandar@ebi.ac.uk>
 * European Bioinformatics Institute (EBI, http://www.ebi.ac.uk/)
 * European Molecular Biology Laboratory (EMBL, http://www.embl.de/)
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at 
 * http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS, 
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and 
 * limitations under the License.
 */
(function(){"use strict";function e(e){return"function"==typeof e||"object"==typeof e&&null!==e}function t(e){return"function"==typeof e}function n(e){j=e}function i(e){N=e}function o(){return function(){process.nextTick(p)}}function a(){return function(){Z(p)}}function r(){var e=0,t=new J(p),n=document.createTextNode("");return t.observe(n,{characterData:!0}),function(){n.data=e=++e%2}}function s(){var e=new MessageChannel;return e.port1.onmessage=p,function(){e.port2.postMessage(0)}}function l(){return function(){setTimeout(p,1)}}function p(){for(var e=0;U>e;e+=2){var t=et[e],n=et[e+1];t(n),et[e]=void 0,et[e+1]=void 0}U=0}function c(){try{var e=require,t=e("vertx");return Z=t.runOnLoop||t.runOnContext,a()}catch(n){return l()}}function h(e,t){var n=this,i=new this.constructor(d);void 0===i[it]&&D(i);var o=n._state;if(o){var a=arguments[o-1];N(function(){I(o,i,a,n._result)})}else P(n,i,e,t);return i}function u(e){var t=this;if(e&&"object"==typeof e&&e.constructor===t)return e;var n=new t(d);return _(n,e),n}function d(){}function f(){return new TypeError("You cannot resolve a promise with itself")}function g(){return new TypeError("A promises callback cannot return that same promise.")}function m(e){try{return e.then}catch(t){return st.error=t,st}}function y(e,t,n,i){try{e.call(t,n,i)}catch(o){return o}}function v(e,t,n){N(function(e){var i=!1,o=y(n,t,function(n){i||(i=!0,t!==n?_(e,n):x(e,n))},function(t){i||(i=!0,S(e,t))},"Settle: "+(e._label||" unknown promise"));!i&&o&&(i=!0,S(e,o))},e)}function b(e,t){t._state===at?x(e,t._result):t._state===rt?S(e,t._result):P(t,void 0,function(t){_(e,t)},function(t){S(e,t)})}function w(e,n,i){n.constructor===e.constructor&&i===tt&&constructor.resolve===nt?b(e,n):i===st?S(e,st.error):void 0===i?x(e,n):t(i)?v(e,n,i):x(e,n)}function _(t,n){t===n?S(t,f()):e(n)?w(t,n,m(n)):x(t,n)}function C(e){e._onerror&&e._onerror(e._result),A(e)}function x(e,t){e._state===ot&&(e._result=t,e._state=at,0!==e._subscribers.length&&N(A,e))}function S(e,t){e._state===ot&&(e._state=rt,e._result=t,N(C,e))}function P(e,t,n,i){var o=e._subscribers,a=o.length;e._onerror=null,o[a]=t,o[a+at]=n,o[a+rt]=i,0===a&&e._state&&N(A,e)}function A(e){var t=e._subscribers,n=e._state;if(0!==t.length){for(var i,o,a=e._result,r=0;r<t.length;r+=3)i=t[r],o=t[r+n],i?I(n,i,o,a):o(a);e._subscribers.length=0}}function T(){this.error=null}function q(e,t){try{return e(t)}catch(n){return lt.error=n,lt}}function I(e,n,i,o){var a,r,s,l,p=t(i);if(p){if(a=q(i,o),a===lt?(l=!0,r=a.error,a=null):s=!0,n===a)return void S(n,g())}else a=o,s=!0;n._state!==ot||(p&&s?_(n,a):l?S(n,r):e===at?x(n,a):e===rt&&S(n,a))}function L(e,t){try{t(function(t){_(e,t)},function(t){S(e,t)})}catch(n){S(e,n)}}function M(){return pt++}function D(e){e[it]=pt++,e._state=void 0,e._result=void 0,e._subscribers=[]}function G(e){return new ft(this,e).promise}function k(e){var t=this;return new t($(e)?function(n,i){for(var o=e.length,a=0;o>a;a++)t.resolve(e[a]).then(n,i)}:function(e,t){t(new TypeError("You must pass an array to race."))})}function E(e){var t=this,n=new t(d);return S(n,e),n}function R(){throw new TypeError("You must pass a resolver function as the first argument to the promise constructor")}function V(){throw new TypeError("Failed to construct 'Promise': Please use the 'new' operator, this object constructor cannot be called as a function.")}function B(e){this[it]=M(),this._result=this._state=void 0,this._subscribers=[],d!==e&&("function"!=typeof e&&R(),this instanceof B?L(this,e):V())}function z(e,t){this._instanceConstructor=e,this.promise=new e(d),this.promise[it]||D(this.promise),Array.isArray(t)?(this._input=t,this.length=t.length,this._remaining=t.length,this._result=new Array(this.length),0===this.length?x(this.promise,this._result):(this.length=this.length||0,this._enumerate(),0===this._remaining&&x(this.promise,this._result))):S(this.promise,O())}function O(){return new Error("Array Methods must be provided an Array")}function F(){var e;if("undefined"!=typeof global)e=global;else if("undefined"!=typeof self)e=self;else try{e=Function("return this")()}catch(t){throw new Error("polyfill failed because global object is unavailable in this environment")}var n=e.Promise;(!n||"[object Promise]"!==Object.prototype.toString.call(n.resolve())||n.cast)&&(e.Promise=dt)}var H;H=Array.isArray?Array.isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)};var Z,j,W,$=H,U=0,N=function(e,t){et[U]=e,et[U+1]=t,U+=2,2===U&&(j?j(p):W())},Y="undefined"!=typeof window?window:void 0,X=Y||{},J=X.MutationObserver||X.WebKitMutationObserver,K="undefined"==typeof self&&"undefined"!=typeof process&&"[object process]"==={}.toString.call(process),Q="undefined"!=typeof Uint8ClampedArray&&"undefined"!=typeof importScripts&&"undefined"!=typeof MessageChannel,et=new Array(1e3);W=K?o():J?r():Q?s():void 0===Y&&"function"==typeof require?c():l();var tt=h,nt=u,it=Math.random().toString(36).substring(16),ot=void 0,at=1,rt=2,st=new T,lt=new T,pt=0,ct=G,ht=k,ut=E,dt=B;B.all=ct,B.race=ht,B.resolve=nt,B.reject=ut,B._setScheduler=n,B._setAsap=i,B._asap=N,B.prototype={constructor:B,then:tt,"catch":function(e){return this.then(null,e)}};var ft=z;z.prototype._enumerate=function(){for(var e=this.length,t=this._input,n=0;this._state===ot&&e>n;n++)this._eachEntry(t[n],n)},z.prototype._eachEntry=function(e,t){var n=this._instanceConstructor,i=n.resolve;if(i===nt){var o=m(e);if(o===tt&&e._state!==ot)this._settledAt(e._state,t,e._result);else if("function"!=typeof o)this._remaining--,this._result[t]=e;else if(n===dt){var a=new n(d);w(a,e,o),this._willSettleAt(a,t)}else this._willSettleAt(new n(function(t){t(e)}),t)}else this._willSettleAt(i(e),t)},z.prototype._settledAt=function(e,t,n){var i=this.promise;i._state===ot&&(this._remaining--,e===rt?S(i,n):this._result[t]=n),0===this._remaining&&x(i,this._result)},z.prototype._willSettleAt=function(e,t){var n=this;P(e,void 0,function(e){n._settledAt(at,t,e)},function(e){n._settledAt(rt,t,e)})};var gt=F,mt={Promise:dt,polyfill:gt};"function"==typeof define&&define.amd?define(function(){return mt}):"undefined"!=typeof module&&module.exports?module.exports=mt:"undefined"!=typeof this&&(this.ES6Promise=mt),gt()}).call(this);var pdbComponentLibraryColors={colorBox:[[[51,123,177],[23,83,137],[5,54,106],[99,175,213],[176,229,251]],[[100,63,145],[100,46,131],[98,99,173],[101,28,117],[99,81,159]],[[154,69,21],[118,39,21],[83,10,21],[189,98,21],[224,127,21]],[[166,72,122],[115,39,89],[218,116,135],[227,146,149],[237,175,170]],[[50,120,114],[39,78,82],[59,156,132],[68,192,147],[74,232,156]],[[97,97,26],[73,73,25],[48,48,20],[118,118,23],[134,134,16]]],colorBox1:[[[0,55,55],[0,75,75],[0,94,94],[0,35,35],[0,114,114],[0,133,133],[0,153,153]],[[0,63,94],[0,76,114],[0,89,133],[0,102,153],[0,115,173],[0,128,192],[0,141,212]],[[51,73,51],[62,88,62],[72,103,72],[82,118,82],[93,133,93],[41,58,41],[103,148,103]]],colorBox2:[[[59,94,94],[53,100,100],[41,112,112],[35,118,118],[29,124,124],[24,129,129],[18,135,135],[12,141,141],[65,88,88]],[[59,82,94],[53,84,100],[47,86,106],[24,94,129],[12,98,141],[65,80,88],[0,102,153]],[[40,57,40],[48,68,48],[56,80,56],[64,91,64],[72,103,72],[80,115,80],[88,126,88],[32,45,32],[24,34,24],[96,138,96]]],colorBox3:[[[99,106,137],[110,118,151],[125,132,161],[140,146,172],[155,160,183]],[[114,72,103],[129,82,117],[145,92,131],[159,104,144],[98,62,89],[169,119,156]],[[111,78,55],[128,90,63],[145,102,72],[94,66,47],[77,54,38],[60,42,30]],[[75,83,32],[92,101,39],[108,120,46],[58,65,25],[42,46,18]],[[57,115,172],[64,128,191],[83,140,198],[121,166,210],[140,179,217]],[[0,81,59],[0,106,78],[0,132,97],[0,55,40],[0,157,116]],[[180,107,65],[191,120,80],[198,135,98],[205,149,117],[212,163,136]]],colorGradients:{redStack:[[128,0,0],[195,33,72],[135,38,87],[112,41,99],[255,56,0],[204,85,0],[255,0,0],[231,84,128],[207,113,175],[148,0,211],[255,127,80],[255,103,0],[244,194,194],[209,159,232],[255,140,0],[255,179,71]],greenStack:[[0,66,37],[85,107,47],[75,83,32],[19,136,8],[141,182,0],[23,114,69],[120,134,107],[3,192,60],[62,180,137]],darkStack:[[128,0,0],[0,0,128],[0,51,0],[102,0,102],[0,51,102],[51,51,0]]},specificColors:{lightGray:[105,105,105],burntOrange:[204,85,0],burgundy:[128,0,0],brass:[104,92,7],airForceBlue:[93,138,168],qualityGreen:[0,128,0],qualityYellow:[255,255,53],qualityRed:[204,0,0],burntOrangeBright:[204,85,0]}};!function(){angular.module("d3Core",[]).factory("d3",function(){return d3})}(),function(){"use strict";angular.module("pdb.common.services",[]).service("commonServices",["$http","$q",function(e){this.apiUrls={summary:"//www.ebi.ac.uk/pdbe/api/pdb/entry/summary/",entities:"//www.ebi.ac.uk/pdbe/api/pdb/entry/entities/",modifiedResidues:"//www.ebi.ac.uk/pdbe/api/pdb/entry/modified_AA_or_NA/",mutatedResidues:"//www.ebi.ac.uk/pdbe/api/pdb/entry/mutated_AA_or_NA/",polymerCoverage:"//www.ebi.ac.uk/pdbe/api/pdb/entry/polymer_coverage/",polymerCoveragePerChain:"//www.ebi.ac.uk/pdbe/api/pdb/entry/polymer_coverage/",bindingSites:"//www.ebi.ac.uk/pdbe/api/pdb/entry/binding_sites/",mappings:"//www.ebi.ac.uk/pdbe/api/mappings/",residueListing:"//www.ebi.ac.uk/pdbe/api/pdb/entry/residue_listing/",secStrutures:"//www.ebi.ac.uk/pdbe/api/pdb/entry/secondary_structure/",outliers:"//www.ebi.ac.uk/pdbe/api/validation/residuewise_outlier_summary/entry/",topology:"//www.ebi.ac.uk/pdbe/api/topology/entry/",molecules:"//www.ebi.ac.uk/pdbe/api/pdb/entry/molecules/",uniProtToPfam:"//www.ebi.ac.uk/pdbe/api/mappings/uniprot_to_pfam/",observedResidueRatio:"//www.ebi.ac.uk/pdbe/api/pdb/entry/observed_residues_ratio/",edm:"//www.ebi.ac.uk/pdbe/coordinates/files/",edm_diff:"//www.ebi.ac.uk/pdbe/coordinates/files/",uniprotSegments:"//www.ebi.ac.uk/pdbe/api/mappings/uniprot_segments/",residueListingPerChain:"//www.ebi.ac.uk/pdbe/api/pdb/entry/residue_listing/",bestStructures:"//www.ebi.ac.uk/pdbe/api/mappings/best_structures/",uniProtApiUrl:"//www.uniprot.org/uniprot/",pdbUniprotDetails:"//www.ebi.ac.uk/pdbe/entry/pdb/uniprot_details/"},this.createPromise=function(t,n,i){var o=this.apiUrls,a=n.map(function(n){if("uniProtApiUrl"===n)return e.get(o[n]+"?query=accession:"+t[0]+"&columns=id,sequence,entry name,protein names,organism,genes&format=tab&limit=1");if("pdbUniprotDetails"===n||"mappings"===n||"uniProtToPfam"===n||"bestStructures"===n)return e.get(o[n]+""+t[0]);if("polymerCoveragePerChain"===n||"topology"===n||"residueListingPerChain"===n)return e.get(o[n]+""+t[0]+"/chain/"+i);if("edm"===n)return e({url:o[n]+""+t[0]+".ccp4",method:"GET",responseType:"blob",cache:!0});if("edm_diff"===n)return e({url:o[n]+""+t[0]+"_diff.ccp4",method:"GET",responseType:"blob",cache:!0});if("uniprotSegments"===n){for(var a=t.length,r=[],s=0;a>s;s++)r.push(e.get(o[n]+""+t[s]));return r}return e({method:"POST",url:o[n],headers:{"Content-Type":"application/x-www-form-urlencoded"},data:t.join(",")})});return a},this.createMultiPromise=function(t,n){var i=this.apiUrls,o=t.map(function(t){return e.get(i[n[0]]+""+t)});return o},this.combinedDataGrabber=function(e,t,n,i){var o=e.map(function(e){return e.then(function(e){return{resolve:!0,result:e}},function(e){return{resolve:!1,result:e}})});return Promise.all(o).then(function(e){var t=[],o=[],a=!0;if(e.forEach(function(e){e.resolve&&(a=!1),t.push(e.resolve?e.result:null),o.push(e.resolve?null:e.result)}),a)throw o;if("undefined"!=typeof i&&i){var r={};return angular.forEach(t,function(e,t){null!==e&&"undefined"!=typeof e&&"undefined"!=typeof e.data&&e.data&&angular.forEach(e.data,function(e,i){var o="";"undefined"!=typeof e&&e&&(o=e),"undefined"==typeof r[i]&&(r[i]={});var a=void 0!=n[t]?n[t]:n[0];r[i][a]=o})}),r}return t})},this.sortMappingFragments=function(e){var t=1;return"-"===e[0]&&(t=-1,e=e.substr(1)),function(n,i){var o=n[e]<i[e]?-1:n[e]>i[e]?1:0;return o*t}},this.checkUniportGapProbability=function(e){for(var t=!1,n=e.length,i=0;n>i;i++){var o=e[i].unp_end-e[i].unp_start,a=e[i].end.residue_number-e[i].start.residue_number,r=o>0?o:-o,s=a>0?a:-a;if(r!=s){t=!0;break}}return t},this.colorBox=pdbComponentLibraryColors.colorBox,this.colorBox1=pdbComponentLibraryColors.colorBox1,this.colorBox2=pdbComponentLibraryColors.colorBox2,this.colorBox3=pdbComponentLibraryColors.colorBox3,this.colorGradients=pdbComponentLibraryColors.colorGradients,this.specificColors=pdbComponentLibraryColors.specificColors,this.availableEvents=[],this.createNewEvent=function(e){var t={};return angular.forEach(e,function(e){var n;"function"==typeof MouseEvent?n=new MouseEvent(e,{view:window,bubbles:!0,cancelable:!0}):"function"==typeof document.createEvent?(n=document.createEvent("MouseEvents"),n.initEvent(e,!0,!0)):"function"==typeof document.createEventObject&&(n=document.createEventObject()),t[e]=n}),t}}]),angular.module("pdb.sequence.view.services",["pdb.common.services"]).service("seqViewerService",["$http","$q","$filter","commonServices",function(){this.pathColorIndex=0,this.setPathColorIndex=function(e){this.pathColorIndex=e},this.getPathColorIndex=function(){return this.pathColorIndex}}])}(),function(){"use strict";angular.module("pdb.sequence.view.filters",["d3Core","pdb.sequence.view.services","pdb.common.services"]).filter("modifiedResFilter",["commonServices",function(e){return function(t,n,i,o,a,r,s,l){var p=[],c=function(e,t){var n={residueNum:t.residue_number,chainId:t.chain_id,entityId:t.entity_id,structAsymId:t.struct_asym_id},i=-1;return angular.forEach(e,function(e){var t={pdbStart:e.pathData.start.residue_number,pdbEnd:e.pathData.end.residue_number,unpStart:e.pathRange[0][0]+1,unpEnd:e.pathRange[1][0]+1,chainId:e.pathData.chain_id,entityId:e.pathData.entity_id,structAsymId:e.pathData.struct_asym_id};n.residueNum>=t.pdbStart&&n.residueNum<=t.pdbEnd&&n.structAsymId<=t.structAsymId&&n.entityId<=t.entityId&&(i=n.residueNum-(t.pdbStart-t.unpStart))}),i},h={shape:"path",shapeGroupClass:"mutationGrp_"+i,shapeClass:"mutation_"+i,shapeHeight:o,marginTop:a,showTooltip:!0,shapeContent:[]},u={shape:"text",shapeGroupClass:"mutationGrp_"+i,shapeClass:"showTextOnZoom singleTextEle mutation_text_"+i,shapeHeight:o,marginTop:a,showTooltip:!0,shapeContent:[]};return angular.forEach(t,function(t){var i=t.residue_number;if("unipdbe"===l)i=c(n,t);else if(t.entity_id!=n.entityId)return;var o="",a="";"undefined"!=typeof t.mutation_details&&"mutatedResidues"===s?(null!==t.mutation_details.from&&(o+=t.mutation_details.from+" --> "),o+=t.mutation_details.to+" ("+t.mutation_details.type+")",a=t.mutation_details.to):(o="Modified Residue: "+t.chem_comp_id,a=""),i>-1&&(h.shapeContent.push({pathRange:[[i-1-.5,0],[i-1+.5,0]],tooltipMsg:o,pathData:t,color:e.specificColors.burntOrange}),u.shapeContent.push({textRange:[[i-1,0],[r,0]],tooltipMsg:o,textString:a,pathData:t,color:e.specificColors.burntOrange}))}),h.shapeContent.length>0&&p.push(h),u.shapeContent.length>0&&p.push(u),p}}]).filter("highlightResideShapeFilter",[function(){return function(e,t){var n="highlightPath highlightPath",i=!1;"click"==t&&(n="selectionPath selectionPath",i=!0);var o={shape:"path",shapeGroupClass:"chain"+e.chainId+"PathGrp"+e.entryId.toLowerCase(),shapeClass:n,shapeHeight:25,marginTop:0,showTooltip:i,shapeContent:[{pathRange:[[e.residueNumber-1-.5,0],[e.residueNumber-1+.5,0]],elementType:"ResidueSelection",pathData:e,color:[0,0,0],opacity:.5}]};return{shapes:[o]}}}]).filter("pdbModelFilter",["$filter","seqViewerService","commonServices",function(e,t,n){return function(i,o,a,r,s,l,p,c,h,u,d){var f=function(e,t){for(var n=e.length,i=0;n>i;i++)if(e[i].entity_id==t)return e[i]},g=function(e,t,n,i,o){var a={idArr:[p],unpShapeObj:{shape:"path",shapeGroupClass:n+"PathGrp"+p,shapeClass:"seqPath "+n+"Path"+p+" "+n+"Path"+p,shapeHeight:15,showTooltip:!0,shapeContent:[]},mappingTextObj:{shape:"text",shapeGroupClass:n+"PathGrp"+p,shapeClass:n+"_text",shapeHeight:15,marginTop:2,showTooltip:!0,shapeContent:[],fitInPath:!0}},r=i.length,s={},l={},c=0;return angular.forEach(e,function(h,u){angular.forEach(h.mappings,function(d){if(d.entity_id==t){if(("cath"===n||"scop"===n)&&d.struct_asym_id!=o)return;var f=d.start.residue_number+"-"+d.end.residue_number;if(f in s)s[f].tooltipMsg=s[f].tooltipMsg.replace("(chain ","(chains "),l[f].tooltipMsg=s[f].tooltipMsg.replace("(chain ","(chains "),s[f].tooltipMsg=s[f].tooltipMsg.replace(")"," "+d.chain_id+")"),l[f].tooltipMsg=s[f].tooltipMsg.replace(")"," "+d.chain_id+")");else{var g,m="";"scop"===n?(g=e[u].sccs,m+="<br><strong>"+g+"</strong><br>"+h.identifier):(g=u,m+="<br><strong>"+g+"</strong><br>"+h.identifier,-1===a.idArr.indexOf(u)&&a.idArr.push(u)),"uniprot"==n&&(m+="<br>UniProt range: "+d.unp_start+" - "+d.unp_end),m+="<br>PDB range: "+d.start.residue_number+" - "+d.end.residue_number+" (chain "+d.chain_id+")",s[f]={pathRange:[[d.start.residue_number-1,0],[d.end.residue_number-1,0]],tooltipMsg:m,tooltipPosition:"postfix",pathData:d,domainId:g,elementType:n,elementColor:i[c],color:i[c]},l[f]={textRange:[[d.start.residue_number+(d.end.residue_number-d.start.residue_number)/2-1,0],[5,0]],textString:h.identifier,pathData:d,pathClassPrefix:n+"Path"+p,fitInPath:!0,tooltipMsg:m,tooltipPosition:"postfix",elementType:n,elementColor:i[c],color:i[c]},c++,c===r&&(c=0)}}})}),angular.forEach(s,function(e,t){a.unpShapeObj.shapeContent.push(e),a.mappingTextObj.shapeContent.push(l[t])}),a},m=function(e,t,i){var o=[],a={shape:"path",shapeGroupClass:"secStrPathGrp"+p,shapeClass:"secStrPath"+p+" secStrPath"+p,shapeHeight:13,showTooltip:!0,shapeContent:[]},r={shape:"arrow",shapeGroupClass:"secStrPathGrp"+p,shapeClass:"arrowPath secStrPath"+p+" secStrPath"+p,shapeHeight:1,showTooltip:!0,shapeContent:[]};return angular.forEach(e,function(e){e.entity_id==t&&angular.forEach(e.chains,function(e){e.struct_asym_id==i&&angular.forEach(e.secondary_structure,function(t,i){"undefined"!=typeof t&&t&&angular.forEach(t,function(t){var o={pathData:{chain_id:e.chain_id,struct_asym_id:e.struct_asym_id,start:t.start,end:t.end},pathRange:[[t.start.residue_number-1,0],[t.end.residue_number-1,0]],tooltipMsg:"",elementType:i.slice(0,-1)};"helices"===i?(o.tooltipMsg="A helix in chain "+e.chain_id,o.elementColor=n.specificColors.brass,o.color=n.specificColors.brass,a.shapeContent.push(o)):"strands"===i&&(o.tooltipMsg="A strand in a sheet in chain "+e.chain_id,o.elementColor=n.specificColors.airForceBlue,o.color=n.specificColors.airForceBlue,r.shapeContent.push(o))})})})}),a.shapeContent.length>0&&o.push(a),r.shapeContent.length>0&&o.push(r),o},y=function(e,t,i,o){var a=t[0].pathData.chain_id,r=t[0].pathData.struct_asym_id,s=[{shape:"path",shapeGroupClass:"quality"+a+"PathGrp"+o,shapeClass:"quality"+a+"Path"+o+" quality"+a+"Path"+o,shapeHeight:15,showTooltip:!0,shapeContent:[]}];return angular.forEach(t,function(e){var t={pathData:e.pathData,pathRange:[[e.pathRange[0][0],0],[e.pathRange[1][0],0]],tooltipMsg:"No validation issue reported for",tooltipPosition:"prefix",elementType:"quality",color:n.specificColors.qualityGreen};s[0].shapeContent.push(t)}),angular.forEach(e,function(e){e.entity_id==i&&angular.forEach(e.chains,function(e){e.chain_id==a&&angular.forEach(e.models,function(e){angular.forEach(e.residues,function(e,t){var i={shape:"path",shapeGroupClass:"quality"+a+"PathGrp"+o,shapeClass:"qualityOverlay"+a+"Path"+o+" qualityOverlay"+a+"Path"+o,shapeHeight:15,showTooltip:!0,shapeContent:[{pathData:e,pathRange:[[e.residue_number-1.5,0],[e.residue_number-.5,0]],tooltipMsg:"",tooltipPosition:"prefix",elementType:"quality_outlier",color:n.specificColors.qualityYellow}]},l="issue";i.shapeContent[0].pathData.chain_id=a,i.shapeContent[0].pathData.struct_asym_id=r,1===e.outlier_types.length&&"RSRZ"===e.outlier_types[0]?(i.shapeContent[0].color=n.specificColors.qualityRed,i.shape="circle",i.shapeClass="qualityCircle"+a+o+t,i.marginTop=-13,i.shapeContent[0].residue_number=e.residue_number,i.shapeContent[0].marginTop=-13):1===e.outlier_types.length?i.shapeContent[0].color=n.specificColors.qualityYellow:2===e.outlier_types.length?(i.shapeContent[0].color=n.specificColors.burntOrangeBright,l="issues"):(i.shapeContent[0].color=n.specificColors.qualityRed,l="issues"),i.shapeContent[0].tooltipMsg="Validation "+l+": "+e.outlier_types.join(", ")+"<br>",s.push(i)})})})}),s[0].shapeContent.length>0?s:[]},v=function(e,t,i,o,a){var r=[];return angular.forEach(e,function(e){if(e.entity_id==t){var s=0;"other"===o&&(s=1),angular.forEach(e.chains,function(e){if("other"!==o||e.struct_asym_id!=a){for(var l={shape:"path",shapeGroupClass:"chain"+e.chain_id+"PathGrp"+i,shapeClass:"seqPath chain"+e.chain_id+"Path"+i+" chain"+e.chain_id+"Path"+i,shapeHeight:15,showTooltip:!0,shapeContent:[]},p=e.observed.length,c=0;p>c;c++)l.shapeContent.push({pathRange:[[e.observed[c].start.residue_number-1,0],[e.observed[c].end.residue_number-1,0]],pathData:{chain_id:e.chain_id,struct_asym_id:e.struct_asym_id,entity_id:t,chain_range:e.observed[c].start.residue_number+"-"+e.observed[c].end.residue_number},elementType:"chain",color:n.colorGradients.darkStack[s]});s++,s===n.colorGradients.darkStack.length&&(s=0),r.push(l)}})}}),r},b=function(e,t,i,o){for(var a={shape:"path",shapeGroupClass:t,shapeClass:"nonSeqPath "+i+"nonSeqPath"+o+" "+i+"nonSeqPath"+o,shapeHeight:6,showTooltip:!0,shapeContent:[]},r=e.length,s=0;r>s;s++)"undefined"!=typeof e[s+1]&&a.shapeContent.push({pathRange:[[e[s].pathRange[1][0],0],[e[s+1].pathRange[0][0],0]],pathData:"",elementType:"unobserved residues",color:n.specificColors.lightGray});return a.shapeContent.length>0?a:{}},w=function(e,t,i,o){var a={},r=[];angular.forEach(e,function(e){if("undefined"!=typeof e.site_residues&&"undefined"!=typeof e.ligand_residues){var n=e.ligand_residues,i=e.site_residues,o=[];angular.forEach(n,function(e){var t=[];null!==e.chem_comp_id&&t.push(e.chem_comp_id),null!==e.chain_id&&t.push(e.chain_id),null!==e.author_residue_number&&t.push(e.author_residue_number),null!==e.author_insertion_code&&t.push(e.author_insertion_code),t.length>0&&o.push(t.join("-"))}),"undefined"==typeof a[e.site_id]&&(a[e.site_id]={}),"undefined"==typeof a[e.site_id].desc&&(a[e.site_id].desc=""),a[e.site_id].desc=o.join(" :: "),angular.forEach(i,function(n){n.struct_asym_id==t&&("undefined"==typeof a[e.site_id].ranges&&(a[e.site_id].ranges=[]),a[e.site_id].ranges.push({residue_number:n.residue_number,tooltipMsg:"",tooltipPosition:"postfix",marginTop:-13,elementType:"binding site",pathData:n,color:""}))})}});var s={},l=0,p=n.colorGradients.greenStack.length;return angular.forEach(a,function(e){if("undefined"!=typeof e.ranges&&e.ranges.length>0){var i={shape:"triangle-up",shapeGroupClass:"bindingSite"+t+"PathGrp"+o,shapeClass:"bindingSite"+t+"Path"+o,shapeHeight:15,showTooltip:!0,marginTop:-13,shapeContent:[]};angular.forEach(e.ranges,function(t){t.tooltipMsg="is in binding site",""!==e.desc&&(t.tooltipMsg+=" of "+e.desc),""===e.desc?"undefined"!=typeof s["null"]?t.color=s["null"]:(t.color=n.colorGradients.greenStack[l],s["null"]=t.color,l++):"undefined"!=typeof s[e.desc]?t.color=s[e.desc]:(t.color=n.colorGradients.greenStack[l],s[e.desc]=t.color,l++),l===p&&(l=0),i.shapeContent.push(t)}),r.push(i)}}),r},_=function(e,t,i,o,a,r,s){var l=[],p={shape:"path",shapeGroupClass:i,shapeClass:"hetConformer"+t+"Path"+a,shapeHeight:15,marginTop:0,showTooltip:!0,shapeContent:[]},c={shape:"path",shapeGroupClass:i,shapeClass:"altConformer"+t+"Path"+a,shapeHeight:15,marginTop:0,showTooltip:!0,shapeContent:[]},h={shape:"text",shapeGroupClass:i,shapeClass:"showTextOnZoom singleTextEle altConformer_text_"+t+"Path"+a,shapeHeight:15,marginTop:2,showTooltip:!0,shapeContent:[]};return angular.forEach(e,function(e){e.entity_id==o&&angular.forEach(e.chains,function(e){e.chain_id==t&&angular.forEach(e.residues,function(e){if("undefined"!=typeof e.multiple_conformers){var i={};angular.forEach(e.multiple_conformers,function(e){"undefined"==typeof i[e.chem_comp_id]&&(i[e.chem_comp_id]={}),i[e.chem_comp_id][e.alt_code]=1});var o="";e.struct_asym_id=s,e.chain_id=t,Object.keys(i).length>1?(o=" has microheterogeneity.",p.shapeContent.push({pathRange:[[e.residue_number-1-.5,0],[e.residue_number-1+.5,0]],tooltipMsg:o,tooltipPosition:"postfix",elementType:"Het Conformer",pathData:e,color:n.specificColors.airForceBlue})):(o=" has alternate conformers.",c.shapeContent.push({pathRange:[[e.residue_number-1-.5,0],[e.residue_number-1+.5,0]],tooltipMsg:o,tooltipPosition:"postfix",elementType:"alternate conformer",pathData:e,color:n.specificColors.airForceBlue})),h.shapeContent.push({textRange:[[e.residue_number-1,0],[4,0]],tooltipMsg:o,tooltipPosition:"postfix",textString:r[e.residue_number-1],pathData:e})}})})}),p.shapeContent.length>0&&l.push(p),c.shapeContent.length>0&&l.push(c),h.shapeContent.length>0&&l.push(h),l},C={groups:[],shapes:[],pathLeftLabels:[]},x=0,S=0;if("undefined"!=typeof i[p].entities){C={options:{seqId:p,seqStr:""},groups:[{label:"","class":"moleculeGrp",parentGroup:"",marginTop:8},{label:"","class":"molPathGrp",parentGroup:"moleculeGrp",marginTop:1},{label:"","class":"molSeqGrp",parentGroup:"moleculeGrp",marginTop:14}],shapes:[{shape:"path",shapeGroupClass:"molPathGrp",shapeClass:"seqPath molPath",shapeHeight:15,marginTop:0,showTooltip:!0,shapeContent:[{pathRange:[[0,0],[0,0]],pathData:{pdbId:p,pdbSeq:""},elementType:"molecule",color:n.specificColors.lightGray,tooltipMsg:"<br><strong>"+p+"</strong>",tooltipPosition:"postfix"}]},{shape:"sequence",shapeGroupClass:"molSeqGrp",shapeClass:"molSeq",shapeContent:{pathRange:[[0,0],[0,0]],pathData:{pdbId:p},elementType:"molecule",color:n.specificColors.lightGray,tooltipMsg:"<br><strong>"+p+"</strong>",tooltipPosition:"postfix"},showTooltip:!0}],pdbIdArr:[],pathLeftLabels:[]};var P=f(i[p].entities,c);C.options.seqStr=C.shapes[0].shapeContent[0].pathData.pdbSeq=P.sequence,C.shapes[0].shapeContent[0].pathRange[1][0]=P.sequence.length}if("undefined"!=typeof i[p].mappings){var A=["UniProt","Pfam"];angular.forEach(A,function(e){var t=e.toLowerCase();if("undefined"!=typeof i[p].mappings[e]&&i[p].mappings[e]){var o=g(i[p].mappings[e],c,t,n.colorBox3[S],d),a=o.unpShapeObj;"undefined"!=typeof a.shapeContent&&a.shapeContent.length>0&&(C.groups.push({label:p,"class":t+"PathGrp"+p,parentGroup:"",marginTop:x+20}),C.shapes.push(a),C.shapes.push(o.mappingTextObj),x+=30,S++,C.pathLeftLabels.push(e)),o.idArr.length>0&&"UniProt"===e&&(C.options.uniprotIdArr=o.idArr)}})}var T="",q="other";if("undefined"!=typeof i[p].polymerCoveragePerChain)T=i[p].polymerCoveragePerChain,q="best";else if("undefined"!=typeof i[p].polymerCoverage){T=i[p].polymerCoverage;for(var I=["scopPathGrp"+p,"cathPathGrp"+p,"secStrPathGrp"+p,"quality"+u+"PathGrp"+p],L=0;3>L;L++){var M=h.select("."+I[L]);if(null!==M[0][0]){var D=M.attr("transform"),G=parseInt(D.substring(D.lastIndexOf(",")+1,D.lastIndexOf(")")))-(20-l);G>x&&(x=G)}}}if("undefined"!=typeof T&&""!==T){var k=v(T.molecules,c,p,q,d);k.length>0&&angular.forEach(k,function(e,t){var l=e.shapeContent[0].pathData.chain_id,h=e.shapeGroupClass;"other"===q&&(h=e.shapeGroupClass+" otherChainPaths"),C.groups.push({label:p,"class":h,parentGroup:"",marginTop:x+20}),C.shapes.push(e),C.shapes.push({shape:"sequence",marginTop:13,shapeGroupClass:k[t].shapeGroupClass,shapeClass:"chain"+l,shapeColour:n.specificColors.airForceBlue,shapeContent:e.shapeContent[0],showTooltip:!0});var u=b(e.shapeContent,e.shapeGroupClass,l,p);u&&C.shapes.push(u),x+=30,S++,C.pathLeftLabels.push("Chain "+l);var d="",f="quality"+l+"PathGrp"+p;if("undefined"!=typeof i[p].outliers?d=i[p].outliers:"undefined"!=typeof o&&""!==o&&(d=o,f="quality"+l+"PathGrp"+p+" otherChainPaths"),"undefined"!=typeof d){var g=y(d.molecules,e.shapeContent,c,p);g&&(C.groups.push({label:p,"class":f,parentGroup:"",marginTop:x+20}),C.shapes=C.shapes.concat(g),x+=30,S++,C.pathLeftLabels.push("Quality"))}var m="",v=e.shapeContent[0].pathData.struct_asym_id,P="bindingSite"+v+"PathGrp"+p;if("undefined"!=typeof i[p].bindingSites?m=i[p].bindingSites:"undefined"!=typeof a&&""!==a&&(m=a),"undefined"!=typeof m){var A=w(m,v,c,p);A.length>0&&(C.groups.push({label:p,"class":P,parentGroup:e.shapeGroupClass,marginTop:0}),C.shapes=C.shapes.concat(A))}var T="";if("undefined"!=typeof i[p].residueListing?T=i[p].residueListing:"undefined"!=typeof r&&""!==r&&(T=r),"undefined"!=typeof T){var I=[];"undefined"!=typeof C.options&&"undefined"!=typeof C.options.seqStr&&""!==C.options.seqStr?I=C.options.seqStr.split(""):"undefined"!=typeof s&&s&&(I=s);var L=_(T.molecules,l,e.shapeGroupClass,c,p,I,v);L.length>0&&(C.groups.push({label:p,"class":e.shapeGroupClass,parentGroup:"",marginTop:0}),C.shapes=C.shapes.concat(L))}})}if("undefined"!=typeof i[p].secStrutures&&"undefined"!=typeof i[p].secStrutures.molecules&&i[p].secStrutures.molecules){var E=m(i[p].secStrutures.molecules,c,d);E&&(C.groups.push({label:p,"class":"secStrPathGrp"+p,parentGroup:"",marginTop:x+20}),C.shapes=C.shapes.concat(E),x+=30,C.pathLeftLabels.push("Sec. Str."))}if("undefined"!=typeof i[p].mappings){var R=["CATH","SCOP"];angular.forEach(R,function(e){var t=e.toLowerCase();if("undefined"!=typeof i[p].mappings[e]&&i[p].mappings[e]){var o=g(i[p].mappings[e],c,t,n.colorBox3[S],d),a=o.unpShapeObj;"undefined"!=typeof a.shapeContent&&a.shapeContent.length>0&&(C.groups.push({label:p,"class":t+"PathGrp"+p,parentGroup:"",marginTop:x+20}),C.shapes.push(a),C.shapes.push(o.mappingTextObj),x+=30,S++,C.pathLeftLabels.push(e))}})}if("undefined"!=typeof i[p].mutatedResidues){var V=e("modifiedResFilter")(i[p].mutatedResidues,{entityId:c},p,15,1,5,"mutatedResidues","pdbeSeq");V.length>0&&(C.groups.push({label:"","class":"mutationGrp mutationGrp_"+p,parentGroup:"moleculeGrp",marginTop:8}),C.shapes=C.shapes.concat(V))}if("undefined"!=typeof i[p].modifiedResidues){var V=e("modifiedResFilter")(i[p].modifiedResidues,{entityId:c},p,15,1,5,"modifiedResidues","pdbeSeq");V.length>0&&(C.groups.push({label:"","class":"mutationGrp mutationGrp_"+p,parentGroup:"moleculeGrp",marginTop:8}),C.shapes=C.shapes.concat(V))}return t.setPathColorIndex(S),C}}])}(),angular.module("template/sequenceView/pdb.html",[]).run(["$templateCache",function(e){e.put("template/sequenceView/pdb.html",'<div class="button-group" ng-show="showViewBtn" ng-style="styles.btnGrp"><ul style="float:right"><li><a ng-click="activeViewBtn = \'compact\'" ng-class="{\'active\' : activeViewBtn == \'compact\'}" title="Compact View" href="javascript:void(0);">Compact</a></li><li><a ng-click="activeViewBtn = \'expanded\'" ng-class="{\'active\' : activeViewBtn == \'expanded\'}" title="Expanded View" href="javascript:void(0);">Expanded</a></li></ul></div><div class="seqViewerWrapper" style="clear:both;" ng-style="styles.wrapper"><div ng-style="seqViewerOverlay" ng-show="overlayText != \'\'"><span ng-style="seqViewerOverlayMessage">{{overlayText}}</span></div><div ng-style="styles.labelsBg">&nbsp;</div><div class="loadMoreChainCl" ng-style="styles.loadMoreStyle" ng-show="showLoadMoreLink"><a href="javascript:void(0);" class="loadMoreBtn" ng-click="loadMoreChains()">load more chains</a></div><div class="loadMoreChainCl chainHideShowBtnCl" ng-style="styles.loadMoreStyle" ng-show="chiansHideShowBtn"><a href="javascript:void(0);" class="loadMoreBtn" ng-click="hideShowChainsFn()">Show {{chainsViewStatus}} chains</a></div><div class="topSection" ng-style="styles.topSection"><div class="topLeftSection" ng-style="styles.leftSecStyle" style="height:100%" ng-show="showLabels"><div class="pdbPathLeftLabel" style="margin-top:42px">Molecule</div></div><a class="SeqScrollArrow" ng-style="styles.scrollArrowLeft" href="javascript:void(0);" title="Scroll Left"><span ng-mouseup="stopMovingPan()" ng-mousemove="stopMovingPan()" ng-mousedown="movePan(50)" class="icon-black" data-icon="&lt;"></span></a><div class="topRightSection"><svg class="topSvg" ng-style="styles.topSvg"><g class="scaleGrp" transform="translate(10,25)"><g class="x axis"></g></g></svn></div><a class="SeqScrollArrow" ng-style="styles.scrollArrowRight" href="javascript:void(0);" title="Scroll Right"><span ng-mouseup="stopMovingPan()" ng-mousemove="stopMovingPan()" ng-mousedown="movePan(-50)" class="icon-black" data-icon="&gt;"></span></a></div><div class="bottomSection" ng-style="styles.bottomSection"><div class="bottomLeftSection" ng-style="styles.leftSecStyle" ng-show="showLabels"><div class="pdbPathLeftLabel" ng-repeat="leftLabel in pathLeftLabels track by $index" ng-style="{\'margin-top\': $index == 0 ? \'9px\' : \'20px\', \'height\': \'10px\', \'line-height\': \'10px\'}">{{leftLabel}}</div><div class="pdbPathLeftLabel moreChainLabels" ng-repeat="moreChainLabel in pathMoreLeftLabels track by $index" ng-style="{\'margin-top\': \'20px\', \'height\': \'10px\', \'line-height\': \'10px\'}">{{moreChainLabel}}</div></div><div class="bottomRightSection"><svg class="bottomSvg" ng-style="styles.bottomSvg" ><g class="shapesGrp" transform="translate(10,-21)"><rect class="seqSvgBg" x="0" y="0" fill="white" stroke="none" ng-style="styles.bottomSvg" ></rect></g></svg></div></div></div>')
}]),function(){"use strict";angular.module("pdb.sequence.viewer",["d3Core","pdb.sequence.view.filters","pdb.sequence.view.services","pdb.common.services","template/sequenceView/pdb.html"]).directive("pdbSeqViewer",["d3","seqViewerService","$compile","$filter","$interval","commonServices","$document","$window","$q",function(e,t,n,i,o,a,r){return{restrict:"EAC",scope:{entryId:"@",entityId:"@",viewerType:"@",settings:"@",height:"@",width:"@",subscribeEvents:"@"},templateUrl:"template/sequenceView/pdb.html",link:function(t,n){t.seqViewerOverlay={width:"90%",height:"100%","background-color":"rgba(0,0,0,0.5)",color:"#fff","z-index":1,position:"absolute","text-align":"center",padding:"0 5%","webkit-box-sizing":"content-box","-moz-box-sizing":"content-box","box-sizing":"content-box"},t.seqViewerOverlayMessage={display:"inline-block","margin-top":"5%","font-size":"12px"},t.overlayText="Loading...";var s=e.select(n[0]),l=s.select(".seqViewerWrapper"),p=l.select(".topRightSection"),c=l.select(".bottomRightSection"),h=c.select(".bottomSvg"),u=h.select("g.shapesGrp"),d=p.select("g.scaleGrp"),f=s.node().parentNode.getBoundingClientRect();t.config={width:f.width>230?f.width:230,height:f.height>250?f.height:250,showLabels:!0,labelWidth:80,maxZoomed:!1},"undefined"!=typeof t.settings&&t.settings&&angular.extend(t.config,JSON.parse(t.settings)),"undefined"!=typeof t.height&&(t.config.height=t.height),"undefined"!=typeof t.width&&(t.config.width=t.width),"undefined"!=typeof t.hideLabels&&"true"==t.hideLabels&&(t.config.showLabels=!1),t.activeViewBtn="compact",t.showViewBtn=!0,t.allowZoom=!0,t.showLoadMoreLink=!1,t.chainsViewStatus="fewer",t.showLabels=t.config.showLabels,"undefined"==typeof t.subscribeEvents&&(t.subscribeEvents="true"),("undefined"==typeof t.viewerType||"unipdbViewer"!==t.viewerType)&&(t.viewerType="pdbViewer");var g=new function(){this.margin={top:15,right:10,bottom:15,left:10},this.topSvgHeight=70,this.topButtonHeight=45,this.loadChainsBtnSecHeight=35,this.mainHeight=t.config.height-this.topButtonHeight,this.leftSecWidth=t.config.showLabels?80:15,this.scrollbarWidth=25,this.scrollRightMargin=5,this.mainWidth=t.config.width,this.sectionWidth=this.mainWidth-this.scrollRightMargin,this.bottomSecHeigth=this.mainHeight-this.topSvgHeight-this.margin.bottom,this.svgWidth=this.sectionWidth-this.leftSecWidth-this.scrollbarWidth,this.svgScaleWidth=this.svgWidth-20,this.tickCount=this.svgWidth/28,this.seqViewerSmallOverlay="position: absolute;padding: 5px;color: #fff;background-color: rgba(0, 0, 0, 0.498039);width: 27%;font-size: 10px;margin-left: 40%;top:0;text-align:center;"};if(t.styles={wrapper:{width:g.mainWidth+"px",height:g.mainHeight+"px"},topSection:{height:g.topSvgHeight+"px",width:g.sectionWidth+"px"},topSvg:{height:g.topSvgHeight+"px",width:g.svgWidth+"px",overflow:"visible"},bottomSection:{height:g.bottomSecHeigth+"px",width:g.sectionWidth+"px","overflow-x":"hidden","overflow-y":"auto"},bottomSvg:{width:g.svgWidth+"px",overflow:"visible",height:"100%"},leftSecStyle:{width:g.leftSecWidth-5+"px","text-align":"right",background:"#DCECD7 none repeat scroll 0% 0%","padding-right":"5px",position:"relative"},labelsBg:{width:g.leftSecWidth-5+"px",background:"#DCECD7 none repeat scroll 0% 0%","padding-right":"5px",height:g.mainHeight+"px",position:"absolute","z-index":0},scrollArrowLeft:{display:"none",position:"absolute",margin:"8px 0 0 "+(g.leftSecWidth-10)+"px","text-decoration":"none",border:"none",outline:"none"},scrollArrowRight:{display:"none",margin:"8px 0 0 20px","text-decoration":"none",border:"none",outline:"none"},loadMoreStyle:{top:g.mainHeight-35+"px",left:g.mainWidth/2-50+"px"},btnGrp:{"float":"left","margin-bottom":"5px",width:g.mainWidth+"px","text-align":"right",overflow:"auto"}},t.wrapperSize={width:g.mainWidth,height:g.mainHeight},"unipdbViewer"===t.viewerType)return t.overlayText="Please use the new '<pdb-uniprot-viewer>' component for UniPDB viewer",!1;if("undefined"==typeof t.entryId)return t.overlayText="Please specify 'entry-id'",void 0;if(t.entryId=t.entryId.toLowerCase(),"undefined"==typeof t.entityId)return t.overlayText="Please specify 'entity-id'",void 0;var m=e.select(".pdbSeqTooltip");null==m[0][0]&&(m=e.select("body").append("div").attr("class","pdbSeqTooltip")),t.pdbevents=a.createNewEvent(["PDB.seqViewer.click","PDB.seqViewer.mouseover","PDB.seqViewer.mouseout"]);var y=function(){function o(){this.smallSeqFlag=!1,this.shapeMaster={},this.renderViewModel=void 0,this.seqLength=0,this.scaleConfig=void 0,this.xScale=void 0,this.line=void 0,this.zoom=void 0,this.xAxis=void 0,this.seqAxis=void 0,this.tickCount=g.tickCount,this.clipPathId=void 0,this.initPdbViewer()}return o.prototype.initPdbViewer=function(){var e=this;t.overlayText="Downloading API Data...";var n=a.createPromise([t.entryId],["observedResidueRatio"]);a.combinedDataGrabber(n,t.entryId,["observedResidueRatio"],!0).then(function(n){if("undefined"!=typeof n[t.entryId].observedResidueRatio[t.entityId]){t.bestChainId=n[t.entryId].observedResidueRatio[t.entityId][0].chain_id,t.bestStructAsymId=n[t.entryId].observedResidueRatio[t.entityId][0].struct_asym_id,n[t.entryId].observedResidueRatio[t.entityId].length>1&&(t.styles.bottomSection.height=g.bottomSecHeigth-g.loadChainsBtnSecHeight+"px",t.showLoadMoreLink=!0);var o=["summary","entities","polymerCoveragePerChain","bindingSites","mappings","secStrutures","outliers","modifiedResidues","mutatedResidues","residueListing"],r=a.createPromise([t.entryId],o,t.bestChainId,t.bestStructAsymId);a.combinedDataGrabber(r,t.entryId,o,!0).then(function(n){t.outlierApiData=n[t.entryId].outliers,t.bindingSitesApiData=n[t.entryId].bindingSites,t.residueListingApiData=n[t.entryId].residueListing,t.overlayText="Parsing API Data...",e.renderViewModel=i("pdbModelFilter")(n,"","","",t.molSeqArr,g.margin.top,t.entryId,t.entityId,s,t.bestChainId,t.bestStructAsymId),e.initScaleAndZoom(),t.overlayText="Rendering View...",e.renderShapes(e.renderViewModel),e.initFitTextInPath(),t.config.maxZoomed&&(e.zoom.scale(maxZoom),e.zoomDraw()),t.overlayText="",e.smallSeqFlag&&(t.showViewBtn=!1),t.$apply()},function(){t.overlayText="Error downloading API Data!",window.console&&console.log("Error: PDB veiwer combined api call failed")})}else t.overlayText="Error: Entity not found!",t.$apply(),window.console&&console.log("Error: Entity not found!!")},function(){t.overlayText="Error downloading API Data!",window.console&&console.log("Error: Observed residue ratio api failed")})},o.prototype.initScaleAndZoom=function(){var n=this;t.overlayText="Initalizing scale and zoom...",t.pathLeftLabels=n.renderViewModel.pathLeftLabels,t.pathMoreLeftLabels=[],t.pdbIdArr=n.renderViewModel.pdbIdArr,t.entrySummary=n.renderViewModel.options,n.sequenceArr=t.entrySummary.seqStr.split(""),n.seqLength=n.sequenceArr.length,n.scaleConfig={indexMax:n.seqLength-1,minZoom:1,maxZoom:n.getMaxZoom(n.seqLength,g.svgScaleWidth)},n.seqLength<=Math.ceil(g.tickCount)&&(n.tickCount=n.seqLength,n.smallSeqFlag=!0),n.xScale=e.scale.linear().domain([0,n.scaleConfig.indexMax]).range([0,g.svgScaleWidth]),n.line=e.svg.line().x(function(e){return n.xScale(e[0])}),n.xAxis=e.svg.axis().scale(n.xScale).orient("top").tickFormat(function(e){return e+1}).ticks(n.tickCount),n.seqAxis=e.svg.axis().scale(n.xScale).orient("top").tickFormat(function(e){return n.sequenceArr[e]}).ticks(n.tickCount);var i=d.select("g.x.axis").call(n.xAxis);n.seqLength===i.selectAll("g.tick")[0].length&&(n.smallSeqFlag=!0),n.zoom=e.behavior.zoom().on("zoom",function(){n.zoomDraw(n)}).x(n.xScale).scaleExtent([n.scaleConfig.minZoom,n.scaleConfig.maxZoom]),p.select(".topSvg").call(n.zoom),c.select(".shapesGrp").call(n.zoom),n.clipPathId="clipper_"+Math.floor(500*Math.random()+1),h.append("defs").append("clipPath").attr("id",n.clipPathId).append("rect").attr("x",-10).attr("y",-30).attr("width",g.svgWidth).attr("height",100)},o.prototype.renderShapes=function(e){var t=this;for(var n in e)if("groups"===n)for(var i=e[n].length,o=0;i>o;o++){var a=e[n][o]["class"],r=e[n][o].parentGroup,s=e[n][o].marginTop,l=(e[n][o].label,u);("moleculeGrp"===r||"moleculeGrp"===a)&&(l=d),""!==r?(l.select("."+r).append("g").attr("class",a),"undefined"!=typeof s&&s&&l.select("."+a).attr("transform","translate(0,"+s+")")):l.append("g").attr("class",a).attr("transform","translate(0,"+(g.margin.top+s)+")").attr("clip-path","url(#"+t.clipPathId+")")}else if("shapes"===n)for(var p=e[n].length,c=0;p>c;c++){var h=e[n][c].shape,f=e[n][c].shapeGroupClass,m=e[n][c].shapeClass,y=e[n][c].shapeContent,v=e[n][c].shapeColour,b=e[n][c].shapeHeight,w=e[n][c].marginTop,_=e[n][c].shapeCap,C=e[n][c].showTooltip,x=e[n][c].fitInPath;"undefined"==typeof b&&(b=0),"undefined"==typeof w&&(w=0),"undefined"==typeof _&&(_="butt"),"text"===h?(t.drawText(y,f,m,C,x),t.displaySeq()):"zigzag"===h?t.drawZigzag(y,f,m,v,b,w,_,C):"arrow"===h?t.drawArrow(y,f,m,v,b,w,_,C):"path"===h?t.drawPath(y,f,m,v,b,w,_,C):"circle"===h||"square"===h||"triangle-up"===h||"triangle-down"===h||"diamond"===h||"cross"===h?t.createShape(h,y,f,m,v,C,w):"sequence"===h&&(t.drawSeqAxis(y,f,m,w,C),t.displaySeq())}},o.prototype.setMainSvgHeight=function(){var e=20;h.select(".seqSvgBg").attr("height",20);var t=u.node().getBBox();h.attr("height",t.height+e),h.select(".seqSvgBg").attr("height",t.height+e)},o.prototype.drawText=function(t,n,i,o,a){var r=this,l=s.select("."+n).attr("clip-path","url(#"+r.clipPathId+")").selectAll("path."+i).data(t).enter().append("text").attr("class",function(e,t){return e.textIndex=t,"textEle "+i+" "+i+"-"+t}).attr("x",function(e){return r.xScale(e.textRange[0][0])}).attr("y",function(e){return e.textRange[1][0]}).attr("fill","white").text(function(e){return e.textString}).style("text-anchor",function(t){return o===!0&&r.attachMouseEvent(e.select(this),"text","white",t),"undefined"!=typeof t.textAnchor?t.textAnchor:"middle"}).style("font-family","Verdana,sans-serif").style("font-size","12px").style("cursor","default");a===!0&&(r.fitTextInPath(l),l.classed("fitTextInPath",!0),l.style("display","none"))},o.prototype.fitTextInPath=function(t){var n=this;t.each(function(){var t=e.select(this),i=t.data()[0],o=s.select("."+i.pathClassPrefix+"-"+i.textIndex).node().getBBox().width;n.textFontResize(t,o)})},o.prototype.textFontResize=function(e,t){var n=this,i=e.node().getBBox().width;if(i>t){var o=parseInt(e.style("font-size"));o>2?(e.style("font-size",o-2+"px"),n.textFontResize(e,t)):e.style("font-size","0px")}},o.prototype.drawZigzag=function(t,n,i,o,a,r,l,p){var c=this;s.select("."+n).attr("clip-path","url(#"+c.clipPathId+")").selectAll("path."+i).data(t).enter().append("path").attr("class",function(e,t){return"linkerPathEle "+i+"-"+t}).attr("stroke",function(t){return e.rgb(t.color[0],t.color[1],t.color[2]).brighter()}).attr("stroke-width",2).attr("stroke-linecap",l).attr("fill",function(t){return e.rgb(t.color[0],t.color[1],t.color[2]).brighter()}).attr("transform","translate(0,-9)").attr("d",function(t){if(1==p){var n=e.rgb(t.color[0],t.color[1],t.color[2]).brighter();c.attachMouseEvent(e.select(this),"path",n,t)}var i=c.getZigZagdVal(c.xScale(t.pathStart),t.pathPosition);return i})},o.prototype.getZigZagdVal=function(e,t){var n=["M","0L","0L","3L","6L","9L","12L","15L","18L"],i=0,o="",a=5;return"start"===t&&(a=-5),angular.forEach(n,function(t){var n=0;0===i?(i=1,n=e):(i=0,n=e+a),o+=t+""+n+","}),o+="18 Z"},o.prototype.createShape=function(t,n,i,o,a,r,l){var p=this;p.shapeMaster[o]=t,s.select("."+i).attr("clip-path","url(#"+p.clipPathId+")").selectAll("otherPathShape path."+o).data(n).enter().append("path").attr("class",o).attr("d",p.getShapeDVal(t)).attr("fill",function(t){var n;return n="undefined"!=typeof t.color?e.rgb(t.color[0],t.color[1],t.color[2]).brighter():a,1==r&&p.attachMouseEvent(e.select(this),"circle",n,t),n}).attr("stroke","none").attr("stroke-width",0).attr("transform",function(e){var t="translate("+p.xScale(e.residue_number-1)+",10)";return 0!==l&&(t="translate("+p.xScale(e.residue_number-1)+","+l+")"),t})},o.prototype.getShapeDVal=function(t){var n=this;return e.svg.symbol().type(t).size(function(){return n.smallSeqFlag?40:10*n.getShapeSize(n.zoom.scale())})},o.prototype.getShapeSize=function(e){return 1.7>e?e=1.7:e>4.5&&(e=4.5),e},o.prototype.drawSeqAxis=function(e,t,n,i,o){var a=this;s.select("."+t).append("g").attr("class","seqAxis "+n);var r=s.select("."+n);r.call(a.seqAxis),i&&"undefined"!=typeof i&&r.attr("transform","translate(0,"+i+")"),1==o&&a.attachMouseEvent(r,"text","white",e)},o.prototype.drawPath=function(t,n,i,o,a,r,l,p){var c=this;s.select("."+n).attr("clip-path","url(#"+c.clipPathId+")").selectAll("path."+i).data(t).enter().append("path").attr("class",function(e,t){return"pathEle "+i+"-"+t}).attr("stroke",function(t){var n;if("undefined"!=typeof t.color){var i=e.rgb(t.color[0],t.color[1],t.color[2]).brighter();n=i}else n=o;return 1==p&&c.attachMouseEvent(e.select(this),"path",n,t),n}).attr("stroke-width",a).attr("stroke-opacity",function(e){return"undefined"!=typeof e.opacity?e.opacity:1}).attr("stroke-linecap",l).attr("fill","none").attr("transform","translate(0,"+r+")").attr("d",function(e){return c.line(e.pathRange)})},o.prototype.drawArrow=function(t,n,i,o,a,r,l,p){var c=this;s.select("."+n).attr("clip-path","url(#"+c.clipPathId+")").selectAll("path."+i).data(t).enter().append("path").attr("class",function(e,t){return"arrowEle "+i+"-"+t}).attr("stroke",function(t){var n=e.rgb(t.color[0],t.color[1],t.color[2]).brighter();return 1==p&&c.attachMouseEvent(e.select(this),"arrow",n,t),n}).attr("stroke-width",a).attr("stroke-linecap",l).attr("fill",function(t){return e.rgb(t.color[0],t.color[1],t.color[2]).brighter()}).attr("transform","translate(0,"+r+")").attr("d",function(e){return c.getArrowDVal(c.line(e.pathRange))})},o.prototype.getArrowDVal=function(e){var t=e.split(","),n=parseFloat(t[0].substring(1)),i=parseFloat(t[1].substring(2)),o=i-n+1,a=5;10>o&&(a=o-2);var r="M"+n+",-5L"+(i-a)+",-5L"+(i-a)+",-10L"+i+",0L"+(i-a)+",10L"+(i-a)+",5L"+n+",5";return r},o.prototype.getMaxZoom=function(e,t){var n=this,i=0;if(t%100===0)i=.2112*e/n.getZoomDivisor(t);else{var o=100*Math.floor(t/100);1>o&&(o=100);var a=.2112*e/n.getZoomDivisor(o),r={100:{diff:2,range:[1,2,4,7,9]},200:{diff:1.5,range:[2,5]},300:{diff:.9,range:[4,9]},400:{diff:.7,range:[5,9]},500:{diff:.6,range:[1,9]},600:{diff:.45,range:[8,9]},700:{diff:.4,range:[8,9]}};if(800>t){for(var s=r[o].range.length,l=s-1;l>=0;l--)if(t>=o+10*r[o].range[l]){i=0===l?a:a-r[o].diff/100*e*l;break}}else i=.2112*e/n.getZoomDivisor(o)}return 0===i&&(i=a),i},o.prototype.getZoomDivisor=function(e){var t=1;return e>100&&(t=Math.floor(Math.floor(e)/100)),t},o.prototype.displaySeq=function(){var t=this;if(t.smallSeqFlag||t.zoom.scale()===t.scaleConfig.maxZoom){s.selectAll(".linkerPathEle").attr("d",function(e){var n=0;n="start"===e.pathPosition?e.pathStart-.1:e.pathStart+.1;var i=t.getZigZagdVal(t.xScale(n),e.pathPosition);return i}),s.selectAll(".seqPath").attr("d",function(e){var n=t.line(e.pathRange),i=n.split(",");return i[0]="M"+(parseFloat(i[0].substring(1))-5),i[1]="0L"+(parseFloat(i[1].substring(2))+5),i.join(",")}),s.selectAll(".nonSeqPath").attr("d",function(e){var n=t.line(e.pathRange),i=n.split(",");return parseFloat(i[0].substring(1))>0&&(i[0]="M"+(parseFloat(i[0].substring(1))+5)),i[1]="0L"+(parseFloat(i[1].substring(2))-5),i.join(",")});var n=s.selectAll(".linePathEle");n.each(function(){e.select(e.select(this).node()).attr("d",function(e){var n=t.line(e.pathRange),i=n.split(","),o=parseFloat(i[0].substring(1))+5,a=i.length;i[0]="M"+o;var r=parseFloat(i[a-2].substring(2))-5;return i[a-2]="5L"+r,i.join(",")})}),s.selectAll(".seqAxis").style("display","block"),s.selectAll(".hideTextOnZoom").style("display","none"),s.selectAll(".showTextOnZoom").style("display","block")}else s.selectAll(".seqAxis").style("display","none"),s.selectAll(".hideTextOnZoom").style("display","block"),s.selectAll(".showTextOnZoom").style("display","none")},o.prototype.zoomDraw=function(){var n=this;n.zoom.scale()>1?s.selectAll(".SeqScrollArrow").style("display","block"):s.selectAll(".SeqScrollArrow").style("display","none"),t.allowZoom===!1&&n.zoom.scale(n.scaleConfig.maxZoom);var i=n.zoom.translate(),o=n.zoom.scale(),a=Math.min(0,Math.max(g.svgScaleWidth*(1-o),i[0])),r=Math.min(0,Math.max(1*(1-o),i[1]));n.zoom.translate([a,r]),d.select("g.x.axis").call(n.xAxis),s.selectAll(".pathEle").each(function(t){e.select(this).attr("d",n.line(t.pathRange))}),s.selectAll(".arrowEle").each(function(t){e.select(this).attr("d",n.getArrowDVal(n.line(t.pathRange)))}),s.selectAll(".linkerPathEle").each(function(t){var i=n.getZigZagdVal(n.xScale(t.pathStart),t.pathPosition);e.select(e.select(this).node()).attr("d",i)}),s.selectAll(".seqAxis").call(n.seqAxis);for(var l in n.shapeMaster)s.selectAll("."+l).attr("d",n.getShapeDVal(n.shapeMaster[l])).attr("transform",function(e){var t="translate("+n.xScale(e.residue_number-1)+",10)";return"undefined"!=typeof e.marginTop&&0!==e.marginTop&&(t="translate("+n.xScale(e.residue_number-1)+","+e.marginTop+")"),t});n.displaySeq(),s.selectAll(".textEle").each(function(){var t=e.select(this),i=t.data()[0];t.attr("x",function(e){return n.xScale(e.textRange[0][0])}),"undefined"!=typeof i&&"undefined"!=typeof i.fitInPath&&i.fitInPath===!0&&(t.style("font-size","12px"),n.fitTextInPath(t))})},o.prototype.initFitTextInPath=function(){var t=this;s.selectAll(".fitTextInPath").each(function(){var n=e.select(this),i=n.data()[0];n.style("display","block"),n.attr("x",function(e){return t.xScale(e.textRange[0][0])}),"undefined"!=typeof i&&"undefined"!=typeof i.fitInPath&&i.fitInPath===!0&&t.fitTextInPath(n)})},o.prototype.showTooltip=function(t,n,i){var o=0,a=0;"ng"===n?(a=i.pageX,o=i.pageY):(a=e.event.pageX,o=e.event.pageY),m.html(t).style("display","block").style("top",o+15+"px").style("left",a+10+"px")},o.prototype.hideTooltip=function(){m.style("display","none")},o.prototype.getResidue=function(e,t){var n=this,i=e[0];return"circle"!==t&&(i=Math.round(n.xScale.invert(e[0]))),"Residue "+(i+1)+" ("+n.sequenceArr[i]+")"},o.prototype.dispatchEvent=function(e,i,o){var a=n[0];"undefined"!=typeof o&&(a=o),"undefined"!=typeof i&&(t.pdbevents[e].eventData=i),a.dispatchEvent(t.pdbevents[e])},o.prototype.eventOperations=function(e,n,i,o,a,r){var s,l,p=this;"undefined"!=typeof r&&(s=r.tooltipMsg,l=r.tooltipPosition),"circle"===i&&(a[0]=r.residue_number-1);var c=p.getResidue(a,i);angular.isUndefined(s)?s=c:angular.isUndefined(l)||"prefix"!==l?angular.isUndefined(l)||"postfix"!==l||(s=c+" "+s):s=s+" "+c,"PDB.seqViewer.mouseover"==e&&p.showTooltip(s,"d3",a),p.dispatchEvent(e,{viewerType:"pdbViewer",elementData:r,residueNumber:parseInt(c.split(" ")[1]),entryId:t.entryId,entityId:t.entityId})},o.prototype.attachMouseEvent=function(n,i,o,a){var r=this;n.on("click",function(){var t=e.mouse(this);r.eventOperations("PDB.seqViewer.click",n,i,o,t,a)}).on("mouseover",function(){var t=e.mouse(this);r.eventOperations("PDB.seqViewer.mouseover",n,i,o,t,a)}).on("mousemove",function(){var t=e.mouse(this);r.eventOperations("PDB.seqViewer.mouseover",n,i,o,t,a)}).on("mouseleave",function(){r.hideTooltip(),r.dispatchEvent("PDB.seqViewer.mouseout",{viewerType:"pdbViewer",entryId:t.entryId,entityId:t.entityId})})},o}(),v=new y;t.$watch("activeViewBtn",function(){"undefined"!=typeof v.zoom&&("expanded"===t.activeViewBtn?(v.zoom.scale(v.scaleConfig.maxZoom),v.zoomDraw(),t.allowZoom=!1):(v.zoom.scale(1),t.allowZoom=!0,v.zoomDraw()))});var b;t.movePan=function(e){var t=v.zoom.translate();v.zoom.translate([t[0]+e,t[1]]),v.zoomDraw(),b=o(function(){var t=v.zoom.translate();v.zoom.translate([t[0]+e,t[1]]),v.zoomDraw()},100)},t.stopMovingPan=function(){o.cancel(b)},t.loadMoreChains=function(){t.showLoadMoreLink=!1,l.append("div").classed("smallOverlayChains",!0).text("Loading Chain API Data..").attr("style",g.seqViewerSmallOverlay);var e=a.createPromise([t.entryId],["polymerCoverage"]);a.combinedDataGrabber(e,t.entryId,["polymerCoverage"],!0).then(function(e){var n=i("pdbModelFilter")(e,t.outlierApiData,t.bindingSitesApiData,t.residueListingApiData,t.molSeqArr,g.margin.top,t.entryId,t.entityId,s,t.bestChainId,t.bestStructAsymId);v.renderShapes(n),t.pathMoreLeftLabels=t.pathMoreLeftLabels.concat(n.pathLeftLabels),t.chainsViewStatus="fewer",t.chiansHideShowBtn=!0,t.$apply(),v.setMainSvgHeight(),l.selectAll(".smallOverlayChains").remove()},function(){l.selectAll(".smallOverlayChains").remove(),window.console&&console.log("load more chains api failed")})},t.hideShowChainsFn=function(){"fewer"==t.chainsViewStatus?(t.chainsViewStatus="more",h.selectAll(".otherChainPaths").style("display","none"),s.selectAll(".moreChainLabels").style("display","none")):(t.chainsViewStatus="fewer",h.selectAll(".otherChainPaths").style("display","block"),s.selectAll(".moreChainLabels").style("display","block")),v.setMainSvgHeight()},t.showTooltip=function(e,t,n){v.showTooltip(e,t,n)},t.hideTooltip=function(){v.hideTooltip()},"true"==t.subscribeEvents&&(r.on("PDB.topologyViewer.click",function(e){if("undefined"!=typeof e.eventData){if(e.eventData.entryId!=t.entryId||e.eventData.entityId!=t.entityId)return;if(e.eventData.chainId!=t.bestChainId)return;s.selectAll(".selectionPath").remove();var n=i("highlightResideShapeFilter")(e.eventData,"click");v.renderShapes(n)}}),r.on("PDB.topologyViewer.mouseover",function(e){if("undefined"!=typeof e.eventData){if(e.eventData.entryId!=t.entryId||e.eventData.entityId!=t.entityId)return;if(e.eventData.chainId!=t.bestChainId)return;s.selectAll(".highlightPath").remove();var n=i("highlightResideShapeFilter")(e.eventData,"mouseover");v.renderShapes(n)}}),r.on("PDB.topologyViewer.mouseout",function(){s.selectAll(".highlightPath").remove()}),r.on("PDB.litemol.mouseover",function(e){if("undefined"==typeof e.eventData||angular.equals({},e.eventData))s.selectAll(".highlightPath").remove();else{if(e.eventData.entryId.toLowerCase()!=t.entryId.toLowerCase()||e.eventData.entityId!=t.entityId)return;s.selectAll(".highlightPath").remove();var n=i("highlightResideShapeFilter")(e.eventData,"mouseover");v.renderShapes(n)}}),r.on("PDB.litemol.click",function(e){if("undefined"!=typeof e.eventData&&!angular.equals({},e.eventData)){if(e.eventData.entryId.toLowerCase()!=t.entryId.toLowerCase()||e.eventData.entityId!=t.entityId)return;s.selectAll(".selectionPath").remove();var n=i("highlightResideShapeFilter")(e.eventData,"click");v.renderShapes(n)}}))}}}])}();